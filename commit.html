<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Commitment Dashboard</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
:root{
  --bg:#f6f9ff;
  --primary:#2f6fed;
  --text:#1f2d3d;
  --muted:#6b7c93;
  --card:#ffffff;
  --border:rgba(47,111,237,0.12);
  --shadow:0 6px 20px rgba(0,0,0,0.05);
  --radius:14px;

  /* Pastel palette */
  --p1:#A8D0E6;
  --p2:#F6C1C7;
  --p3:#C3FBD8;
  --p4:#FBE7C6;
  --p5:#D7C0F5;
  --p6:#B5EAD7;
}
body{
  font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
  background: var(--bg);
  margin:0;
  padding:25px;
  color:var(--text);
}
.dashboard{
  max-width:1400px;
  margin:auto;
}
h1{
  text-align:center;
  color:var(--primary);
  margin-bottom:10px;
}
.last-updated{
  text-align:center;
  color:var(--muted);
  font-size:13px;
  margin-bottom:25px;
}

.topbar{
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:20px;
}
select{
  padding:10px 14px;
  border-radius:10px;
  border:1px solid var(--border);
  background:white;
  font-weight:600;
  color:var(--primary);
  box-shadow:var(--shadow);
}

.cards{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(250px,1fr));
  gap:18px;
  margin-bottom:30px;
}
.card{
  background:var(--card);
  border-radius:var(--radius);
  box-shadow:var(--shadow);
  padding:18px;
  border-left:6px solid var(--primary);
}
.card h3{
  margin:0;
  font-size:13px;
  color:var(--primary);
}
.card p{
  font-size:24px;
  font-weight:800;
  margin:8px 0 0;
}

.panel{
  background:white;
  border-radius:var(--radius);
  box-shadow:var(--shadow);
  padding:20px;
  margin-bottom:25px;
}
.panel h2{
  font-size:15px;
  margin-bottom:15px;
  color:var(--primary);
}
</style>
</head>

<body>
<div class="dashboard">

<h1>Commitment Dashboard</h1>
<div class="last-updated" id="lastUpdated">Loading...</div>

<div class="topbar">
  <select id="batchFilter"></select>
</div>

<div class="cards">
  <div class="card">
    <h3>Total Bookings</h3>
    <p id="totalBookings">0</p>
  </div>
  <div class="card">
    <h3 id="batchTitle">Most Active Batch</h3>
    <p id="batchValue">-</p>
  </div>
  <div class="card">
    <h3>Most Used Slot</h3>
    <p id="topSlot">-</p>
  </div>
  <div class="card">
    <h3>Most Booked Day</h3>
    <p id="topDay">-</p>
  </div>
</div>

<div class="panel">
  <h2>Slot Usage (Stacked by Batch)</h2>
  <canvas id="slotChart"></canvas>
</div>

<div class="panel">
  <h2>Daily Bookings (Stacked by Batch)</h2>
  <canvas id="dayChart"></canvas>
</div>

<div class="panel">
  <h2>Daily Trend</h2>
  <canvas id="trendChart"></canvas>
</div>

</div>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycby0YeYV4cPrKu1xHaZhnH_JCDbaW7V8emXuopSRJYXLczeunu8EKKTkYPcyCt8IpTc6/exec";
const REFRESH_INTERVAL = 60000;

let RAW = null;
let slotChart, dayChart, trendChart;
let lastFetchTime = null;

const pastelColors = ["#A8D0E6","#F6C1C7","#C3FBD8","#FBE7C6","#D7C0F5","#B5EAD7"];

async function fetchData(initial=false){
  const res = await fetch(API_URL, { cache: "no-store" });
  RAW = await res.json();
  lastFetchTime = new Date();

  if(initial){
    buildDropdown();
  }
  render();
  updateLastUpdated();
}

function buildDropdown(){
  const dd = document.getElementById("batchFilter");
  dd.innerHTML="";
  dd.innerHTML += `<option value="All">All Batches</option>`;
  const batches = [...new Set(RAW.analytics.map(r=>r.Batch))].sort();
  batches.forEach(b=>{
    dd.innerHTML += `<option value="${b}">${b}</option>`;
  });
}

function getFiltered(){
  const selected = document.getElementById("batchFilter").value;
  const analytics = selected==="All" ? RAW.analytics : RAW.analytics.filter(r=>r.Batch===selected);
  const slots = selected==="All" ? RAW.slots : RAW.slots.filter(r=>r.Batch===selected);
  return {selected, analytics, slots};
}

function sumRow(r){
  return Object.keys(r).reduce((s,k)=>k==="Batch"?s:s+Number(r[k]),0);
}

function columnTotals(rows){
  const totals={};
  rows.forEach(r=>{
    Object.keys(r).forEach(k=>{
      if(k==="Batch") return;
      totals[k]=(totals[k]||0)+Number(r[k]);
    });
  });
  return totals;
}

function render(){
  const {selected,analytics,slots}=getFiltered();

  // Total Bookings
  let total=0;
  analytics.forEach(r=>total+=sumRow(r));
  document.getElementById("totalBookings").textContent=total.toLocaleString();

  if(selected==="All"){
    document.getElementById("batchTitle").textContent="Most Active Batch";
    let batchTotals={};
    RAW.analytics.forEach(r=>batchTotals[r.Batch]=sumRow(r));
    document.getElementById("batchValue").textContent=
      Object.keys(batchTotals).reduce((a,b)=>batchTotals[a]>batchTotals[b]?a:b);
  }else{
    document.getElementById("batchTitle").textContent="Current Batch";
    document.getElementById("batchValue").textContent=selected;
  }

  const slotTotals=columnTotals(slots);
  document.getElementById("topSlot").textContent=
    Object.keys(slotTotals).reduce((a,b)=>slotTotals[a]>slotTotals[b]?a:b);

  const dayTotals=columnTotals(analytics);
  document.getElementById("topDay").textContent=
    Object.keys(dayTotals).reduce((a,b)=>dayTotals[a]>dayTotals[b]?a:b);

  renderStackedChart("slotChart", slots, "Slot Usage");
  renderStackedChart("dayChart", analytics, "Daily Bookings");
  renderTrend(analytics);
}

function renderStackedChart(id,data,label){
  const ctx=document.getElementById(id);
  if(window[id]) window[id].destroy();

  const labels=Object.keys(data[0]).filter(k=>k!=="Batch");

  const datasets=data.map((batch,i)=>({
    label:batch.Batch,
    data:labels.map(l=>Number(batch[l])),
    backgroundColor:pastelColors[i%pastelColors.length]
  }));

  window[id]=new Chart(ctx,{
    type:"bar",
    data:{labels,datasets},
    options:{
      responsive:true,
      plugins:{legend:{position:"top"}},
      scales:{
        x:{stacked:true},
        y:{stacked:true}
      }
    }
  });
}

function renderTrend(data){
  const totals=columnTotals(data);
  if(trendChart) trendChart.destroy();
  trendChart=new Chart(document.getElementById("trendChart"),{
    type:"line",
    data:{
      labels:Object.keys(totals),
      datasets:[{
        label:"Trend",
        data:Object.values(totals),
        borderColor:"#2f6fed",
        backgroundColor:"rgba(47,111,237,0.1)",
        tension:0.3,
        fill:true
      }]
    }
  });
}

function updateLastUpdated(){
  const el=document.getElementById("lastUpdated");
  if(!lastFetchTime) return;
  const now=new Date();
  const diff=Math.floor((now-lastFetchTime)/1000);
  if(diff<60) el.textContent="Last updated just now";
  else el.textContent="Last updated "+Math.floor(diff/60)+" minute(s) ago";
}

document.getElementById("batchFilter").addEventListener("change",render);

fetchData(true);
setInterval(fetchData,REFRESH_INTERVAL);
setInterval(updateLastUpdated,1000);
</script>
</body>
</html>



